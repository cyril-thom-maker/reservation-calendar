<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Reservation Page</title>
<style>
body { font-family: Arial; padding:20px; background:#f4f4f4; }
h1 { text-align:center; }
#calendar-nav { text-align:center; margin-bottom:10px; }
#calendar-days { display:flex; max-width:420px; margin:0 auto; justify-content:space-between; font-weight:bold; }
#days { display:grid; grid-template-columns:repeat(7, 1fr); max-width:420px; margin:0 auto; gap:5px; }
.day { width:100%; aspect-ratio:1/1; display:flex; align-items:center; justify-content:center; cursor:pointer; border-radius:5px; color:white; font-weight:bold; }
.day.free { background:#4CAF50; } /* green = free */
.day.occupied { background:#f44336; cursor:not-allowed; } /* red = occupied */
.day.selected { background:#2196F3; } /* blue = selected */
form { max-width:420px; margin:20px auto; text-align:center; }
input, select, textarea { margin:5px; padding:5px; width:90%; }
button { padding:5px 10px; margin-top:10px; }
</style>
</head>
<body>

<h1>Your Reservation</h1>

<div id="calendar-nav">
  <button id="prev-month">&lt; Previous</button>
  <span id="month-label"></span>
  <button id="next-month">Next &gt;</button>
</div>

<div id="calendar-days">
  <div>Mon</div><div>Tue</div><div>Wed</div>
  <div>Thu</div><div>Fri</div><div>Sat</div><div>Sun</div>
</div>

<div id="days"></div>

<form id="reservation-form">
  <input type="text" id="name" placeholder="Your Name" required /><br>
  <select id="type" required>
    <option value="">--Select Reservation Type--</option>
    <option value="Workshop Day">Workshop Day</option>
    <option value="Test Day">Test Day</option>
    <option value="Race Day">Race Day</option>
  </select><br>
  <textarea id="details" placeholder="Additional details (optional)"></textarea><br>
  <button type="submit">Submit Reservation</button>
</form>

<script>
let selectedDates = [];
let currentDate = new Date();

const daysContainer = document.getElementById("days");
const monthLabel = document.getElementById("month-label");
const prevBtn = document.getElementById("prev-month");
const nextBtn = document.getElementById("next-month");

function getAllReservedDates(){
  const confirmed = JSON.parse(localStorage.getItem("confirmedReservations") || "[]");
  let dates = [];
  confirmed.forEach(r => { dates = dates.concat(r.days); });
  return dates;
}

function renderCalendar(date){
  daysContainer.innerHTML = "";
  const year = date.getFullYear();
  const month = date.getMonth();
  monthLabel.textContent = date.toLocaleString('default', { month: 'long', year: 'numeric' });

  const reservedDates = getAllReservedDates();
  let firstDayOfMonth = new Date(year, month, 1).getDay(); // 0=Sunday
  const numDays = new Date(year, month+1, 0).getDate();

  // Ajustement pour que la semaine commence lundi
  let offset = firstDayOfMonth === 0 ? 6 : firstDayOfMonth - 1;

  // Ajouter cases vides pour aligner le 1er jour
  for(let i=0; i<offset; i++){
    const emptyDiv = document.createElement("div");
    daysContainer.appendChild(emptyDiv);
  }

  for(let d=1; d<=numDays; d++){
    const div = document.createElement("div");
    const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    div.textContent = d;
    div.dataset.date = dateStr;
    div.className = "day";

    if(reservedDates.includes(dateStr)) div.classList.add("occupied");
    else div.classList.add("free");

    if(selectedDates.includes(dateStr)) div.classList.add("selected");

    div.onclick = () => {
      if(div.classList.contains("occupied")) return;
      if(selectedDates.includes(dateStr)){
        selectedDates = selectedDates.filter(x => x !== dateStr);
        div.classList.remove("selected");
      } else {
        selectedDates.push(dateStr);
        div.classList.add("selected");
      }
    };

    daysContainer.appendChild(div);
  }
}

prevBtn.onclick = () => { currentDate.setMonth(currentDate.getMonth()-1); renderCalendar(currentDate); }
nextBtn.onclick = () => { currentDate.setMonth(currentDate.getMonth()+1); renderCalendar(currentDate); }

renderCalendar(currentDate);

document.getElementById("reservation-form").addEventListener("submit", function(e){
  e.preventDefault();
  if(selectedDates.length === 0){ alert("Please select at least one day."); return; }

  const name = document.getElementById("name").value.trim();
  const type = document.getElementById("type").value;
  const details = document.getElementById("details").value.trim();

  if(!name || !type){ alert("Please fill your name and select a reservation type."); return; }

  let pending = JSON.parse(localStorage.getItem("pendingReservations") || "[]");
  pending.push({name,type,details,days:selectedDates});
  localStorage.setItem("pendingReservations", JSON.stringify(pending));
  alert("Your reservation has been submitted! Admin will confirm.");

  selectedDates = [];
  renderCalendar(currentDate);
  document.getElementById("reservation-form").reset();
});
</script>

</body>
</html>