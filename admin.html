<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Panel</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body { font-family: Arial; margin:0; padding:20px; max-width:900px; margin:auto; }
h2 { text-align:center; }

#calendar-nav { text-align:center; margin:10px 0; }
#calendar-days, #calendar { display:grid; grid-template-columns:repeat(7,1fr); text-align:center; gap:5px; margin:auto; }
#calendar .day { aspect-ratio:1/1; display:flex; justify-content:center; align-items:center; border-radius:5px; color:white; font-weight:bold; cursor:pointer; }
.day.free { background:#4CAF50; }
.day.pending { background:#FF9800; }
.day.confirmed { background:#f44336; }

.card { border:1px solid #ccc; padding:10px; margin-bottom:10px; border-radius:5px; }
button { margin:5px; padding:5px 10px; cursor:pointer; }

@media (min-width:768px){ #calendar, #calendar-days { max-width:800px; } }
@media (min-width:1024px){ #calendar, #calendar-days { max-width:900px; } }
</style>
</head>
<body>

<h2>Admin Panel</h2>

<div id="calendar-nav">
  <button id="prev-month">&lt; Prev</button>
  <span id="month-label"></span>
  <button id="next-month">Next &gt;</button>
</div>

<div id="calendar-days">
  <div>Mon</div><div>Tue</div><div>Wed</div>
  <div>Thu</div><div>Fri</div><div>Sat</div><div>Sun</div>
</div>

<div id="calendar"></div>

<h3>Reservations</h3>
<div id="list"></div>

<script>
let reservations = JSON.parse(localStorage.getItem("reservations") || "[]");
let currentDate = new Date();

// Render calendar
function renderCalendar(){
  const calendarEl = document.getElementById("calendar");
  calendarEl.innerHTML="";
  const year = currentDate.getFullYear();
  const month = currentDate.getMonth();
  document.getElementById("month-label").textContent=currentDate.toLocaleString("default",{month:"long",year:"numeric"});

  const numDays = new Date(year, month+1,0).getDate();
  const firstDay = new Date(year, month,1).getDay();
  const offset = firstDay === 0 ? 6 : firstDay-1;

  const statusByDate = {};
  reservations.forEach(r=>r.days.forEach(d=>statusByDate[d]=r.status));

  for(let i=0;i<offset;i++) calendarEl.appendChild(document.createElement("div"));

  for(let d=1; d<=numDays; d++){
    const dateStr=`${year}-${String(month+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
    const div=document.createElement("div");
    div.textContent=d;
    div.dataset.date=dateStr;
    const status=statusByDate[dateStr]||"free";
    div.className="day "+status;

    if(status==="confirmed"){
      div.onclick=()=>{
        if(confirm("Cancel this day? "+dateStr)){
          cancelSingleDay(dateStr);
        }
      }
    }

    calendarEl.appendChild(div);
  }
}

// Cancel a single confirmed day
function cancelSingleDay(dateStr){
  reservations = reservations.map(r=>{
    if(r.status==="confirmed" && r.days.includes(dateStr)){
      r.days = r.days.filter(d=>d!==dateStr);
      if(r.days.length===0) return null;
    }
    return r;
  }).filter(r=>r!==null);
  localStorage.setItem("reservations", JSON.stringify(reservations));
  renderCalendar();
  loadList();
}

// Display reservation list
function loadList(){
  const list=document.getElementById("list");
  list.innerHTML="";
  reservations.forEach(r=>{
    const div=document.createElement("div");
    div.className="card "+r.status;

    let addButton="";
    if(r.status==="confirmed"){
      addButton=`<button onclick="exportICS('${r.id}')">Add to Apple Calendar</button>`;
    }

    div.innerHTML=`<strong>${r.name}</strong><br>
      ${r.type}<br>
      ${r.days.join(", ")}<br>
      ${r.details || ""}<br>
      ${r.status==="pending" ? `<button onclick="confirmRes(${r.id})">Confirm</button>` : ""}
      <button onclick="cancelRes(${r.id})">Cancel</button>
      ${addButton}`;
    list.appendChild(div);
  });
}

// Confirm a pending reservation
function confirmRes(id){
  reservations = reservations.map(r=>{if(r.id===id) r.status="confirmed"; return r;});
  localStorage.setItem("reservations", JSON.stringify(reservations));
  renderCalendar();
  loadList();
}

// Cancel an entire reservation
function cancelRes(id){
  reservations = reservations.filter(r=>r.id!==id);
  localStorage.setItem("reservations", JSON.stringify(reservations));
  renderCalendar();
  loadList();
}

// Export ICS for Apple Calendar (Mac + iOS)
function exportICS(id){
  const r = reservations.find(res=>res.id===id);
  if(!r) return;

  let ics = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//YourCompany//Reservation Calendar//EN
CALSCALE:GREGORIAN
`;

  r.days.forEach(d=>{
    ics += `BEGIN:VEVENT
DTSTART;VALUE=DATE:${d.replace(/-/g,"")}
DTEND;VALUE=DATE:${d.replace(/-/g,"")}
SUMMARY:${r.type} - ${r.name}
DESCRIPTION:${r.details || ""}
END:VEVENT
`;
  });

  ics += "END:VCALENDAR";

  const blob = new Blob([ics], { type: "text/calendar;charset=utf-8" });
  const url = URL.createObjectURL(blob);

  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
  if(isIOS){
    // iOS / Safari: open in new tab for “Add to Calendar”
    window.open(url, "_blank");
  } else {
    // Desktop / Mac: download file
    const a = document.createElement("a");
    a.href = url;
    a.download = `reservation_${r.name.replace(/\s+/g,'_')}.ics`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  }

  setTimeout(()=>URL.revokeObjectURL(url),1000);
}

// Month navigation
document.getElementById("prev-month").onclick=()=>{
  currentDate.setMonth(currentDate.getMonth()-1);
  renderCalendar();
};
document.getElementById("next-month").onclick=()=>{
  currentDate.setMonth(currentDate.getMonth()+1);
  renderCalendar();
};

// Auto-refresh reservations
setInterval(()=>{
  reservations = JSON.parse(localStorage.getItem("reservations") || "[]");
  renderCalendar();
  loadList();
},1000);

renderCalendar();
loadList();
</script>

</body>
</html>
